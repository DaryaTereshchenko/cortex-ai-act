###############################################################################
# CORTEX-AI-ACT  —  Continuous Deployment
###############################################################################
# Triggers:
#   - Push to main (auto-deploy to staging via Codespaces)
#   - Release published (deploy to production)
#   - Manual dispatch
#
# Environments (configure in repo Settings → Environments):
#   staging    — auto-deployed on main merges (Codespaces or SSH)
#   production — deployed on releases; requires approval
#
# Deploy methods (set DEPLOY_METHOD variable in environment):
#   codespaces  — free tier, no server needed (default for staging)
#   ssh         — Nuvelos / self-hosted GPU server
#   docker-context — remote Docker via SSH
###############################################################################

name: CD

on:
  push:
    branches: [main]
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment"
        required: true
        type: choice
        options:
          - staging
          - production
        default: staging

concurrency:
  group: cd-${{ github.event.inputs.environment || (github.event_name == 'release' && 'production') || 'staging' }}
  cancel-in-progress: false

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/cortex-ai-act

permissions:
  contents: read
  packages: read

jobs:
  # =========================================================================
  # Determine target environment
  # =========================================================================
  resolve-env:
    name: Resolve environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.env.outputs.environment }}
    steps:
      - id: env
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            echo "environment=production" >> "$GITHUB_OUTPUT"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "environment=${{ github.event.inputs.environment }}" >> "$GITHUB_OUTPUT"
          else
            echo "environment=staging" >> "$GITHUB_OUTPUT"
          fi

  # =========================================================================
  # Deploy
  # =========================================================================
  deploy:
    name: "Deploy to ${{ needs.resolve-env.outputs.environment }}"
    runs-on: ubuntu-latest
    needs: resolve-env
    environment:
      name: ${{ needs.resolve-env.outputs.environment }}
      url: ${{ vars.DEPLOY_URL }}
    steps:
      - uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # -----------------------------------------------------------------
      # Option A: Codespaces deploy (FREE — no server needed)
      # Default for staging. Creates a persistent Codespace running
      # the full stack with public port forwarding.
      # -----------------------------------------------------------------
      - name: Deploy via Codespaces
        if: vars.DEPLOY_METHOD == 'codespaces' || vars.DEPLOY_METHOD == ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          DISPLAY_NAME="cortex-staging"
          SHORT_SHA="${GITHUB_SHA:0:7}"

          # Delete any previous staging Codespace to save quota
          echo "Cleaning up previous staging Codespaces…"
          gh codespace list --json name,displayName -q \
            '.[] | select(.displayName == "'"$DISPLAY_NAME"'") | .name' | \
            while read -r cs; do
              echo "  Deleting $cs"
              gh codespace delete --codespace "$cs" --force 2>/dev/null || true
            done

          # Create a new Codespace from main branch
          echo "Creating staging Codespace ($SHORT_SHA)…"
          gh codespace create \
            --repo "${{ github.repository }}" \
            --branch "main" \
            --display-name "$DISPLAY_NAME" \
            --machine "basicLinux32gb" \
            --retention-period "168h" \
            --idle-timeout "60m"

          # Look up the actual codespace name (auto-generated by GitHub)
          ACTUAL_NAME=$(gh codespace list --json name,displayName -q \
            '.[] | select(.displayName == "'"$DISPLAY_NAME"'") | .name' | head -1)
          echo "Codespace name: $ACTUAL_NAME"

          # Wait for it to be ready
          for i in $(seq 1 40); do
            state=$(gh codespace view --codespace "$ACTUAL_NAME" --json state -q '.state' 2>/dev/null || echo "unknown")
            echo "  [$i/40] state=$state"
            if [[ "$state" == "Available" ]]; then
              echo "Codespace is ready!"
              break
            fi
            sleep 15
          done

          # Output the URL
          echo "## Staging Codespace deployed" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Codespace:** $ACTUAL_NAME" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Commit:** $SHORT_SHA" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Open:** https://github.com/codespaces" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "Services on forwarded ports: 8501 (UI), 8001 (KG), 8002 (RE), 8003 (Bench), 7474 (Neo4j)" >> "$GITHUB_STEP_SUMMARY"

      # -----------------------------------------------------------------
      # Option B: SSH deploy (for Nuvelos / self-hosted GPU server)
      # -----------------------------------------------------------------
      - name: Deploy via SSH
        if: vars.DEPLOY_METHOD == 'ssh'
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            cd ${{ vars.DEPLOY_PATH || '~/cortex-ai-act' }}
            git pull origin main
            docker compose pull
            docker compose up -d --remove-orphans
            docker image prune -f

      # -----------------------------------------------------------------
      # Option C: Docker-compose up via docker context
      # -----------------------------------------------------------------
      - name: Deploy via Docker context
        if: vars.DEPLOY_METHOD == 'docker-context'
        run: |
          echo "${{ secrets.DEPLOY_SSH_KEY }}" > /tmp/deploy_key
          chmod 600 /tmp/deploy_key
          docker context create remote \
            --docker "host=ssh://${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}"
          docker --context remote compose pull
          docker --context remote compose up -d --remove-orphans
          rm -f /tmp/deploy_key

      # -----------------------------------------------------------------
      # Smoke test (for SSH / docker-context deploys with a known URL)
      # -----------------------------------------------------------------
      - name: Smoke test
        if: vars.DEPLOY_URL
        run: |
          sleep 15
          for endpoint in health; do
            status=$(curl -s -o /dev/null -w "%{http_code}" "${{ vars.DEPLOY_URL }}/${endpoint}" || true)
            echo "GET /${endpoint} → HTTP ${status}"
            if [[ "${status}" != "200" ]]; then
              echo "::warning::Smoke test failed for /${endpoint} (HTTP ${status})"
            fi
          done

  # =========================================================================
  # Post-deploy notification (optional)
  # =========================================================================
  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [resolve-env, deploy]
    if: always()
    steps:
      - name: Post deploy status
        run: |
          ENV="${{ needs.resolve-env.outputs.environment }}"
          STATUS="${{ needs.deploy.result }}"
          echo "## Deployment to **${ENV}** — ${STATUS}" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Commit:** \`${{ github.sha }}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Actor:** ${{ github.actor }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Triggered by:** ${{ github.event_name }}" >> "$GITHUB_STEP_SUMMARY"
