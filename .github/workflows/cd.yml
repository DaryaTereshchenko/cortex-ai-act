###############################################################################
# CORTEX-AI-ACT  —  Continuous Deployment
###############################################################################
# Triggers:
#   - Push to main (posts staging link to Codespaces)
#   - Release published (deploy to production via SSH)
#   - Manual dispatch
#
# Staging:
#   Uses GitHub Codespaces manually — click "Open in Codespaces" on the repo.
#   The .devcontainer config auto-starts the full stack.
#
# Production (when you have a server):
#   Set DEPLOY_METHOD=ssh in environment variables and add SSH secrets.
###############################################################################

name: CD

on:
  push:
    branches: [main]
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment"
        required: true
        type: choice
        options:
          - staging
          - production
        default: staging

concurrency:
  group: cd-${{ github.event.inputs.environment || (github.event_name == 'release' && 'production') || 'staging' }}
  cancel-in-progress: false

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/cortex-ai-act

permissions:
  contents: read
  packages: read

jobs:
  # =========================================================================
  # Determine target environment
  # =========================================================================
  resolve-env:
    name: Resolve environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.env.outputs.environment }}
    steps:
      - id: env
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            echo "environment=production" >> "$GITHUB_OUTPUT"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "environment=${{ github.event.inputs.environment }}" >> "$GITHUB_OUTPUT"
          else
            echo "environment=staging" >> "$GITHUB_OUTPUT"
          fi

  # =========================================================================
  # Deploy
  # =========================================================================
  deploy:
    name: "Deploy to ${{ needs.resolve-env.outputs.environment }}"
    runs-on: ubuntu-latest
    needs: resolve-env
    environment:
      name: ${{ needs.resolve-env.outputs.environment }}
      url: ${{ vars.DEPLOY_URL }}
    steps:
      - uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # -----------------------------------------------------------------
      # Staging: Codespaces (manual — no server needed)
      # The devcontainer config handles everything. This step just
      # posts a helpful link in the workflow summary.
      # -----------------------------------------------------------------
      - name: Staging via Codespaces
        if: needs.resolve-env.outputs.environment == 'staging' && vars.DEPLOY_METHOD != 'ssh' && vars.DEPLOY_METHOD != 'docker-context'
        run: |
          SHORT_SHA="${GITHUB_SHA:0:7}"
          REPO_URL="https://github.com/${{ github.repository }}"

          cat >> "$GITHUB_STEP_SUMMARY" <<'HEREDOC'
          ## Staging ready — open in Codespaces

          Click below to launch the full CORTEX stack in a free Codespace:

          HEREDOC

          echo "**[Open in Codespaces](${REPO_URL}/codespaces/new?ref=main&machine=basicLinux32gb)**" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Service | Port |" >> "$GITHUB_STEP_SUMMARY"
          echo "|---------|------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Web UI (Streamlit) | 8501 |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Knowledge-Graph API | 8001 |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Reasoning-Engine API | 8002 |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Benchmarking API | 8003 |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Neo4j Browser | 7474 |" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "> Commit: \`${SHORT_SHA}\` — The devcontainer config auto-starts all services." >> "$GITHUB_STEP_SUMMARY"

          echo "Staging is available via Codespaces (no server deploy needed)."

      # -----------------------------------------------------------------
      # Production: SSH deploy (for Nuvelos / self-hosted GPU server)
      # -----------------------------------------------------------------
      - name: Deploy via SSH
        if: vars.DEPLOY_METHOD == 'ssh'
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            cd ${{ vars.DEPLOY_PATH || '~/cortex-ai-act' }}
            git pull origin main
            docker compose pull
            docker compose up -d --remove-orphans
            docker image prune -f

      # -----------------------------------------------------------------
      # Configure: DEPLOY_METHOD=ssh + DEPLOY_HOST, DEPLOY_USER,
      #            DEPLOY_SSH_KEY secrets
      # -----------------------------------------------------------------
      # -----------------------------------------------------------------
      - name: Deploy via Docker context
        if: vars.DEPLOY_METHOD == 'docker-context'
        run: |
          echo "${{ secrets.DEPLOY_SSH_KEY }}" > /tmp/deploy_key
          chmod 600 /tmp/deploy_key
          docker context create remote \
            --docker "host=ssh://${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}"
          docker --context remote compose pull
          docker --context remote compose up -d --remove-orphans
          rm -f /tmp/deploy_key

      # -----------------------------------------------------------------
      # Smoke test (for SSH / docker-context deploys with a known URL)
      # -----------------------------------------------------------------
      - name: Smoke test
        if: vars.DEPLOY_URL
        run: |
          sleep 15
          for endpoint in health; do
            status=$(curl -s -o /dev/null -w "%{http_code}" "${{ vars.DEPLOY_URL }}/${endpoint}" || true)
            echo "GET /${endpoint} → HTTP ${status}"
            if [[ "${status}" != "200" ]]; then
              echo "::warning::Smoke test failed for /${endpoint} (HTTP ${status})"
            fi
          done

  # =========================================================================
  # Post-deploy notification (optional)
  # =========================================================================
  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [resolve-env, deploy]
    if: always()
    steps:
      - name: Post deploy status
        run: |
          ENV="${{ needs.resolve-env.outputs.environment }}"
          STATUS="${{ needs.deploy.result }}"
          echo "## Deployment to **${ENV}** — ${STATUS}" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Commit:** \`${{ github.sha }}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Actor:** ${{ github.actor }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Triggered by:** ${{ github.event_name }}" >> "$GITHUB_STEP_SUMMARY"
