###############################################################################
# CORTEX-AI-ACT  ‚Äî  Codespaces Preview Environment
###############################################################################
# Creates an on-demand preview Codespace for each PR so reviewers can
# spin up the full stack with one click.
#
# Free-tier: 60 core-hours/month (= 30 hrs on 2-core machine).
# Auto-deletes after the PR closes to save quota.
###############################################################################

name: Preview Environment

on:
  pull_request:
    types: [opened, synchronize, reopened]
  pull_request_target:
    types: [closed]

permissions:
  contents: read
  pull-requests: write

env:
  CODESPACE_NAME: cortex-preview-pr-${{ github.event.pull_request.number }}

jobs:
  # =========================================================================
  # Create / update preview on PR open or push
  # =========================================================================
  create-preview:
    name: Create preview environment
    if: github.event.action != 'closed'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for existing Codespace
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DISPLAY_NAME: ${{ env.CODESPACE_NAME }}
        run: |
          actual=$(gh codespace list --json name,displayName -q \
            '.[] | select(.displayName == "'"$DISPLAY_NAME"'") | .name' | head -1)
          if [[ -n "$actual" ]]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
            echo "actual_name=$actual" >> "$GITHUB_OUTPUT"
            echo "Codespace already exists ($actual) ‚Äî will rebuild."
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create Codespace
        if: steps.check.outputs.exists == 'false'
        id: create
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DISPLAY_NAME: ${{ env.CODESPACE_NAME }}
        run: |
          gh codespace create \
            --repo "${{ github.repository }}" \
            --branch "${{ github.head_ref }}" \
            --display-name "$DISPLAY_NAME" \
            --machine "basicLinux32gb" \
            --retention-period "72h" \
            --idle-timeout "30m"

          # Look up the actual name assigned by GitHub
          actual=$(gh codespace list --json name,displayName -q \
            '.[] | select(.displayName == "'"$DISPLAY_NAME"'") | .name' | head -1)
          echo "actual_name=$actual" >> "$GITHUB_OUTPUT"

      - name: Rebuild Codespace (on new push)
        if: steps.check.outputs.exists == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh codespace rebuild --codespace "${{ steps.check.outputs.actual_name }}" || true

      - name: Wait for Codespace
        id: url
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ACTUAL_NAME="${{ steps.create.outputs.actual_name || steps.check.outputs.actual_name }}"
          for i in $(seq 1 30); do
            state=$(gh codespace view --codespace "$ACTUAL_NAME" --json state -q '.state' 2>/dev/null || echo "unknown")
            echo "Attempt $i: state=$state"
            if [[ "$state" == "Available" ]]; then
              break
            fi
            sleep 10
          done

      - name: Comment on PR with preview link
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## üñ•Ô∏è Preview Environment

            A Codespace preview is available for this PR.

            **[Open in Codespaces](https://github.com/codespaces)**

            Once the Codespace starts, the full CORTEX stack will launch automatically:
            | Service | Access via Ports tab |
            |---------|---------------------|
            | Web UI (Streamlit) | Port 8501 |
            | Knowledge-Graph API | Port 8001 |
            | Reasoning-Engine API | Port 8002 |
            | Benchmarking API | Port 8003 |
            | Neo4j Browser | Port 7474 |

            > ‚è±Ô∏è Codespace auto-stops after 30min idle. Auto-deletes 72h after last use.
            > üí° Free tier: 60 core-hours/month.`;

            // Find and update existing comment, or create new one
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('Preview Environment')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }

  # =========================================================================
  # Cleanup preview on PR close / merge
  # =========================================================================
  cleanup-preview:
    name: Cleanup preview environment
    if: github.event.action == 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Delete Codespace
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DISPLAY_NAME: ${{ env.CODESPACE_NAME }}
        run: |
          # Look up actual name by display name, then delete
          actual=$(gh codespace list --json name,displayName -q \
            '.[] | select(.displayName == "'"$DISPLAY_NAME"'") | .name' | head -1)
          if [[ -n "$actual" ]]; then
            gh codespace delete --codespace "$actual" --force
          else
            echo "Codespace already deleted or not found."
          fi

      - name: Comment cleanup notice
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('Preview Environment')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: '## üñ•Ô∏è Preview Environment\n\n~~Preview Codespace has been cleaned up~~ (PR closed).',
              });
            }
