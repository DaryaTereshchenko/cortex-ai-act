###############################################################################
# CORTEX-AI-ACT  —  PR Preview Comment
###############################################################################
# Posts a comment on every PR with a one-click link to open the branch
# in GitHub Codespaces. The devcontainer config auto-starts the full stack.
#
# No Codespace API calls — reviewers launch manually via the link.
# Free tier: 60 core-hours/month (= ~30 hrs on 2-core machine).
###############################################################################

name: Preview Environment

on:
  pull_request:
    types: [opened, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  post-preview-link:
    name: Post Codespaces preview link
    runs-on: ubuntu-latest
    steps:
      - name: Comment on PR with preview link
        uses: actions/github-script@v7
        with:
          script: |
            const repo = context.repo;
            const branch = context.payload.pull_request.head.ref;
            const repoUrl = `https://github.com/${repo.owner}/${repo.repo}`;
            const codespaceUrl = `${repoUrl}/codespaces/new?ref=${encodeURIComponent(branch)}&machine=basicLinux32gb`;

            const body = [
              `## Preview Environment`,
              ``,
              `Click below to launch this branch in a Codespace with the full CORTEX stack:`,
              ``,
              `**[Open in Codespaces](${codespaceUrl})**`,
              ``,
              `| Service | Port |`,
              `|---------|------|`,
              `| Web UI (Streamlit) | 8501 |`,
              `| Knowledge-Graph API | 8001 |`,
              `| Reasoning-Engine API | 8002 |`,
              `| Benchmarking API | 8003 |`,
              `| Neo4j Browser | 7474 |`,
              ``,
              `> The devcontainer config auto-starts all services.`,
              `> Free tier: 60 core-hours/month.`,
            ].join('\n');

            // Find and update existing comment, or create new one
            const { data: comments } = await github.rest.issues.listComments({
              owner: repo.owner,
              repo: repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('Preview Environment')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: repo.owner,
                repo: repo.repo,
                comment_id: botComment.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: repo.owner,
                repo: repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }
